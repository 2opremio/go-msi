<?xml version="1.0"?>
<?define ProductVersion = "0.0.8"?>
<?define ProductUpgradeCode = "8A8A4A40-D596-481D-ACC2-5F9EA29CD738"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

   <Product Id="*" UpgradeCode="{{.UpgradeCode}}"
            Name="{{.Product}}"
            Version="{{.Version}}"
            Manufacturer="{{.Company}}"
            Language="1033">

      <Package InstallerVersion="200" Compressed="yes" Comments="Windows Installer Package"/>

      <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

      <Upgrade Id="{{.UpgradeCode}}">
         <UpgradeVersion Minimum="{{.Version}}" OnlyDetect="yes" Property="NEWERVERSIONDETECTED"/>
         <UpgradeVersion Minimum="0.0.0" Maximum="{{.Version}}" IncludeMinimum="yes" IncludeMaximum="no"
                         Property="OLDERVERSIONBEINGUPGRADED"/>
      </Upgrade>
      <Condition Message="A newer version of this software is already installed.">NOT NEWERVERSIONDETECTED</Condition>

      <Directory Id="TARGETDIR" Name="SourceDir">

         <Directory Id="ProgramFilesFolder">
            <Directory Id="INSTALLDIR" Name="{{.Files.Dir}}">
               {{if len(.Files.Items)>0}}
               <Component Id="ApplicationFiles" Guid="{{.Files.Guid}}">
                  {{range $i, $e := .Files.Items}}
                    <File Id="ApplicationFile{{$i}}" Source="{{$e}}"/>
                  {{end}}
               </Component>
               {{- end}}
               {{if len(.Files.Directories)>0}}
               {{range $i, $e := .Files.Directories}}
               <Directory Id="APPDIR{{$i}}" Name="$(var.SourceDir{{$i}})" />
               {{end}}
               {{- end}}
            </Directory>
         </Directory>

         {{if len(.Env)>0}}
         <Component Id="ENVS" Guid="{{.Env.Guid}}">
          {{range $i, $e := .Env.Vars}}
          <Environment Id="ENV{{$i}}"
            Name="{{$e.Name}}"
            Value="{{$e.Value}}"
            Permanent="{{$e.Permanent}}"
            Part="{{$e.Part}}"
            Action="{{$e.Action}}"
            System="{{$e.System}}" />
          {{end}}
        </Component>
        {{- end}}

         {{if len(.Shortcuts.Items)>0}}
         <Directory Id="ProgramMenuFolder">
            <Directory Id="ProgramMenuSubfolder" Name="{{.Shortcuts.Dir}}">
               <Component Id="ApplicationShortcuts" Guid="{{$e.Guid}}">
               {{range $i, $e := .Shortcuts.Items}}
                  <Shortcut Id="ApplicationShortcut{{$i}}"
                        Name="{{$e.Name}}"
                        Description="{{$e.Description}}"
                        Target="{{$e.Target}}"
                        WorkingDirectory="{{$e.WDir}}"
                        Arguments="{{$e.Guid}}"
                        />
                  <RegistryValue Root="HKCU"
                    Key="Software\{{.Company}}\{{.Product}}"
                    Name="installed{{$i}}"
                    Type="integer" Value="1" KeyPath="yes"/>
                {{- end}}
                <RemoveFolder Id="ProgramMenuSubfolder" On="uninstall"/>
               </Component>
            </Directory>
         </Directory>
         {{- end}}

      </Directory>

      <InstallExecuteSequence>
         <RemoveExistingProducts After="InstallValidate"/>
      </InstallExecuteSequence>

      <Feature Id="DefaultFeature" Level="1">
         {{if len(.Env)>0}}
         <ComponentRef Id="ENVS"/>
         {{- end}}
         {{if len(.Files.Items)>0}}
         <ComponentRef Id="ApplicationFiles"/>
         {{- end}}
         {{if len(.Shortcuts.Items)>0}}
         <ComponentRef Id="ApplicationShortcuts"/>
         {{- end}}
         {{range $i, $e := .Files.Directories}}
         <ComponentGroupRef Id="AppFiles{{$i}}" />
         {{- end}}
      </Feature>

      <UI>
         <!-- Define the installer UI -->
         <UIRef Id="WixUI_HK" />
      </UI>

      <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

   </Product>

</Wix>
